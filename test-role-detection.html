<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Role Detection</title>
</head>
<body>
    <h1>Test Role Detection System</h1>
    <div id="results"></div>
    
    <script>
        // Mock Memberstack data based on what we saw in network logs
        window.$memberstackDom = {
            getCurrentMember: async () => ({
                data: {
                    id: "mem_sb_cmc5172o7000d0wsa0ng2hgkb",
                    metaData: {
                        lmids: "117"
                    },
                    planConnections: [
                        {
                            id: "con_sb_cmc5189cw00u70ww5dlh366nl",
                            active: true,
                            status: "ACTIVE",
                            planId: "pln_educators-free-promo-ebfw0xzj",
                            type: "FREE"
                        }
                    ]
                }
            })
        };
        
        // Test role detection function
        let currentUserRole = null;

        async function detectUserRole() {
            if (currentUserRole) {
                return currentUserRole;
            }
            
            try {
                const memberstack = window.$memberstackDom;
                if (!memberstack) {
                    console.warn('Memberstack not available, defaulting to teacher role');
                    currentUserRole = 'teacher';
                    return currentUserRole;
                }
                
                const { data: memberData } = await memberstack.getCurrentMember();
                if (!memberData) {
                    console.warn('No member data available, defaulting to teacher role');
                    currentUserRole = 'teacher';
                    return currentUserRole;
                }
                
                // Detect role based on Memberstack plan
                const planConnections = memberData.planConnections || [];
                const activePlans = planConnections.filter(conn => conn.active && conn.status === 'ACTIVE');
                
                // Check if user has any parent plan
                const hasParentPlan = activePlans.some(plan => 
                    plan.planId.includes('parent') || 
                    plan.planId === 'pln_parents-y1ea03qk'
                );
                
                // Check if user has any educator/therapist plan
                const hasEducatorPlan = activePlans.some(plan => 
                    plan.planId.includes('educator') || 
                    plan.planId.includes('therapist') ||
                    plan.planId.includes('free-plan')
                );
                
                if (hasParentPlan) {
                    currentUserRole = 'parent';
                } else if (hasEducatorPlan) {
                    currentUserRole = 'teacher';
                } else {
                    // Fallback: check metadata for explicit role override
                    const metaRole = memberData.metaData?.role;
                    if (metaRole === 'parent' || metaRole === 'teacher') {
                        currentUserRole = metaRole;
                        console.log(`User role detected from metadata: ${currentUserRole}`);
                    } else {
                        console.warn('No recognizable plan found, defaulting to teacher role');
                        currentUserRole = 'teacher';
                    }
                }
                
                console.log(`User role detected from plan: ${currentUserRole} (plans: ${activePlans.map(p => p.planId).join(', ')})`);
                return currentUserRole;
            } catch (error) {
                console.error('Error detecting user role:', error);
                currentUserRole = 'teacher';
                return currentUserRole;
            }
        }

        async function getCurrentMemberId() {
            try {
                const memberstack = window.$memberstackDom;
                if (!memberstack) {
                    return null;
                }
                
                const { data: memberData } = await memberstack.getCurrentMember();
                return memberData?.id || null;
            } catch (error) {
                console.error('Error getting member ID:', error);
                return null;
            }
        }

        // Test the functions
        async function runTests() {
            const resultsDiv = document.getElementById('results');
            
            try {
                console.log('üß™ Testing role detection...');
                const role = await detectUserRole();
                const memberId = await getCurrentMemberId();
                
                resultsDiv.innerHTML = `
                    <h2>Test Results:</h2>
                    <p><strong>Detected Role:</strong> ${role}</p>
                    <p><strong>Member ID:</strong> ${memberId}</p>
                    <p><strong>Expected Role:</strong> teacher (based on educator plan)</p>
                    <p><strong>Test Status:</strong> ${role === 'teacher' ? '‚úÖ PASSED' : '‚ùå FAILED'}</p>
                    
                    <h3>Test Scenarios:</h3>
                    <h4>Teacher Recording Filename:</h4>
                    <p>kids-world_spookyland-lmid_117-question_1-tm_${Date.now()}.mp3</p>
                    
                    <h4>Parent Recording Filename (if role was parent):</h4>
                    <p>parent_${memberId}-world_spookyland-lmid_117-question_1-tm_${Date.now()}.mp3</p>
                `;
                
                console.log('‚úÖ Role detection test completed');
                console.log(`Role: ${role}, Member ID: ${memberId}`);
                
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                resultsDiv.innerHTML = `<p style="color: red;">Test failed: ${error.message}</p>`;
            }
        }
        
        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html> 